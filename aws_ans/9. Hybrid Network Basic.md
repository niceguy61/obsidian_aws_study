## 9. Hybrid Network Basic
### VPN Routing - Static vs Dynamic
![[hybrid_network.png]]
- 네트워크 고유 식별자를 **AS**라 부르며 다른 네트워크와 경로를 교환할 수 있는 모든 라우터다.
- 식별자의 ID를 **ASN**이라 부른다.
- 공용ASN이라면 IANA에서 부여한다. (**1 - 64495**)
- 다른 네트워크간 통신이 되길 원한다면 사설ASN도 사용할 수 있다 (**64512 - 65534**)
- 사설 연결로 구성하면 BGP도 사용할 수 있다.
### Static Routing (고정 라우팅)
![[hybrid_network_static_routing.png]]
![[hybrid_network_static_problem1.png]]
- 단점 : 만일 A -> C로 보내고 싶은데, **A는 C가 어딘지 모르므로 트래픽을 Drop해버릴 수 있다.**
- 해결 : **A Route Table에서 10.30.0.0/16을 Router C로 수동 등록해야 함.**
### Dynamic Routing (동적 라우팅)
![[hybrid_network_dynamic.png]]
- 네트워크 B에서 C가 연결된 내용이 확인되면 **자동으로 A 네트워크에 프로토콜을 통해 공유한다.**
### BGP (Border Gateway Protocol)
- Path-Vector 프로토콜을 사용하는 동적 라우팅에서는 피어(peer) 또는 자율 시스템(AS, Autonomous System) 간에 목적지로 가는 최적 경로를 교환합니다.
	- **iBGP**: AS 내에서의 라우팅.
	- **eBGP**: AS 간의 라우팅.
- 라우팅 결정은 다음에 의해 영향을 받습니다:
	- **Weight**: Cisco 라우터에서 사용하는 AS 내에서만 작동하는 값.
	- **ASPATH**: 경로를 따라 이동해야 하는 AS들의 순서 (AS 간에서 작동).
	- **Local Preference (LOCAL_PREF)**: AS 내에서 작동.
	- **MED (Multi-Exit Discriminator)**: AS 간에서 작동.
![[how_bgp_works.png]]
- 모든 AS에는 라우터 테이블이 있고 **BGP 테이블**이라고 불리운다.
- BGP에서 통신 경로의 순위를 매길때 목적지, next hop, 경로를 선택해야 하는데 이를 **PATH**라 한다.
- 표에 나와 있는 Path에서 보면 ASN,i (internal) 형태로 Path가 추가된다.
- BGP가 하는 일은 **BGP 이웃들이 경로를 이해하거나 학습하거나 해서 다른 AS에 정보를 전달하는 것.**
![[how_bpg_works2.png]]
- 그래서 경로 학습이 끝나면 400, 300,i 와 200,300,i 가 선택된다.
- 만일 100 -> 200으로의 통신이 다운되었다고 가정하면
	- AS 100 -> 300으로 갈때 400,300,i가 연결 경로가 된다.
	- **통신 장애 극복에 이용된다.**
### BGP Route Selection (ASPATH, LOCAL_PREF, MED)
#### 1. AS_PATH
![[bgp_route_sel_aspath.png]]
- **역할**: AS 간의 최단 경로를 계산하며, 짧은 AS_PATH 값을 가진 경로가 더 선호됨.
- **동작 원리**:
    - 각 AS는 BGP 업데이트 메시지에 자신을 AS_PATH에 추가.
    - AS_PATH는 목적지 Network까지의 경로를 나타냄.
- 속도를 빠르게 하는 기술
	- **AS_PATH Prepending**을 이용하면 강제로 홉을 더 끼워 넣어서 네트워크 경로를 조절 할 수 있다.
	- 예시
		- 100 -> 200 (2Mbps), AS_PATH 더 짧아서 기본적으로 우선순위 높음 (200,i)
		- 100 -> 400 -> 200 (10Mbps) 도 방법이지만, AS_PATH상에선 우선순위 낮음 (400,200,i)
		- AS_PATH Prepending을 이용해서 강제로 200에 링크를 삽입 (200,200,200,i)
		- 100 -> 200 연결 시도시 길이가 길어져 100 -> 400 -> 200이 더 우선시 된다.
#### 2. LOCAL_PREF
![[how_bgp_works3.png]]
- **정의**: BGP에서 AS 내부에서 사용되는 경로 선택 기준으로, 가장 높은 Local Preference 값이 우선.
- **역할**: AS 내부의 트래픽 경로를 제어.
- **적용 범위**: AS 내부에서만 유효하며, 다른 AS로 전파되지 않음.
- **기본값**: Local Preference 값은 기본적으로 100으로 설정됨.
- **그림 설명**
	1. **AS 200 (10.20.0.0/16)**
	    - Local Preference = 200 (우선 경로)
	    - 경로 `10.20.0.1`을 통해 외부 네트워크로 연결.
	2. **AS 400 (10.40.0.0/16)**
	    - Local Preference = 100 (낮은 우선순위)
	    - 경로 `10.40.0.1` 사용.
	3. **AS 300 (10.30.0.0/16)**
	    - AS 내부에서 두 개의 외부 경로를 통해 다른 네트워크로 연결:
	        - AS 200 → Local Preference = 200 (우선).
	        - AS 400 → Local Preference = 100 (후순위).
#### 3. MED (Multi Exit Discriminator)
![[how_bgp_works4.png]]
- **역할**: AS 간의 경로 선택에서 우선순위를 부여하며, 값이 낮을수록 높은 우선순위를 가짐.
- **적용 범위**: BGP의 선택 과정에서 **Local Preference, AS Path**가 동일한 경우 적용됨.
- **동작 방식**: AS 간 경로에 대해 특정 진입점을 우선시하거나, 트래픽이 특정 링크를 통해 유입되도록 경로 선택을 유도.
-  **그림 예제 설명**
	1. **네트워크 구성**:
	    - AS 100 (10.10.0.0/16)과 AS 400 (10.40.0.0/16)이 두 개의 BGP 경로로 연결됨.
	    - AS 400은 두 개의 라우터(10.40.1.15와 10.40.0.1)를 통해 AS 100으로 연결.
	    - **MED 값**:
	        - 10.40.1.15 → MED=5
	        - 10.40.0.1 → MED=2 (더 낮은 값)
	2. **BGP 경로 선택 과정**:
	    - **Local Preference**: 동일 (그림에서 LOCAL_PREF가 같음).
	    - **AS_PATH 길이**: 동일 (둘 다 "400" 경로 사용).
	    - **MED 값 비교**:
	        - 10.40.0.1 (MED=2)이 10.40.1.15 (MED=5)보다 낮으므로 더 높은 우선순위를 가짐.
	3. **결과**:
	    - AS 100은 10.40.0.1을 통해 AS 400으로 트래픽을 보냄.
	    - **경로**: `10.40.0.1`이 선호되므로 초록색 경로를 통해 트래픽이 유입.

| ==특성==      | ==AS_PATH==               | ==LOCAL_PREF==         | ==MED==                     |
| ----------- | ------------------------- | ---------------------- | --------------------------- |
| 정의          | 경로를 거친 AS의 순서를 나타냄        | AS 내부에서 경로 우선순위를 결정    | AS 외부에서 들어오는 경로의 우선순위를 결정   |
| 주 사용 목적     | 경로 길이에 따라 짧은 경로를 선호       | AS 내부 트래픽 흐름을 최적화      | 외부 AS로부터 들어오는 트래픽의 선호 경로 지정 |
| 기본값         | 각 경로에 대해 자동 업데이트          | 기본값 = 100              | 기본값 = 0                     |
| 조작 가능 여부    | **Prepending으로 길이 조작 가능** | 사용자가 원하는 값으로 조정 가능     | 낮은 값으로 조정 가능                |
| 적용 범위       | AS 간 전파                   | AS 내부에서만 유효            | 다른 AS로 전파되지 않음              |
| 선호 경로 결정    | 경로 길이가 짧을수록 선호            | 값이 높을수록 선호             | 값이 낮을수록 선호                  |
| 루프 방지 역할    | 루프 감지 및 제거                | 역할 없음                  | 역할 없음                       |
| 설정 위치       | 온프레미스 또는 BGP 라우터에서 설정     | 온프레미스 또는 BGP 라우터에서 설정  | 온프레미스 또는 BGP 라우터에서 설정       |
| AWS 내 설정 여부 | 직접 설정 불가 (온프레미스에서만 가능)    | 직접 설정 불가 (온프레미스에서만 가능) | 직접 설정 불가 (온프레미스에서만 가능)      |
| 일반적인 사용 사례  | 짧은 경로를 선호하도록 조정           | 특정 경로 우선 지정            | 외부에서 낮은 값을 부여해 경로 선호 조정     |
#### BGP Route Selection 순서와 속성
##### **Highest Weight**
- Cisco 라우터에서 사용하는 특정 속성
- AS 내부에서만 작동하며, 경로를 생성한 라우터에 의해 설정됨
- 외부 BGP 라우터 간에는 교환되지 않음
##### **1. Local Preference**
- 외부 BGP(eBGP) 경로 중 아웃바운드 경로 선택
- 내부 BGP(iBGP) 라우터 간 우선순위 설정
- 외부 BGP 라우터 간에는 교환되지 않음
- 기본값은 100
##### **2. AS Path**
- AS 경로가 가장 짧은 경로를 선호
- AS Path는 AS Path Prepend를 사용하여 더 길게 만들어 우선순위를 낮출 수 있음
##### **3. Multi Exit Discriminator (MED)**
- 두 AS 간 여러 경로가 있을 때 사용
- MED 값이 낮을수록 더 높은 우선순위를 가짐
- AS 간에 MED 값이 교환됨
